from Standard.Base import all

from Standard.Database import SQL_Query, Raw_SQL, Table_Name
import Standard.Table.Data.Table as Materialized_Table
import Standard.Database.Data.Table as Database_Table
from Standard.Database.Data.SQL import Statement, SQL_Type
import Standard.Database.Internal.IR

type Fake_Test_Connection
    # type Fake_Test_Connection_Data (tables : Map Text (Vector [Text, SQL_Type])) (dialect : Text)
    Fake_Test_Connection_Data tables dialect

    ## Set up a query returning a Table object, which can be used to work with data within the database or load it into memory.

       Arguments:
       - query: name of the table or sql statement to query.
         If supplied as `Text`, the name is checked against the `tables` list to determine if it is a table or a query.
       - alias: optionally specify a friendly alias for the query.
    query : Text | SQL_Query -> Text -> Database_Table
    query self query alias="" = case query of
        Text -> self.query (Table_Name query) alias
        Raw_SQL _ ->
            Error.throw (Illegal_Argument_Error "Cannot query a fake connection with raw SQL")
        Table_Name name ->
            columns = self.tables.get name
            Database_Table.make_table self name columns (IR.context_for_table name)

    ## Execute the query and load the results into memory as a Table.

       Arguments:
       - query: name of the table or sql statement to query.
         If supplied as `Text`, the name is checked against the `tables` list to determine if it is a table or a query.
       - alias: optionally specify a friendly alias for the query.
       - limit: the maximum number of rows to return (default 1000).
    read : Text | SQL_Query -> Text -> Integer | Nothing -> Table
    read self _ _="" _=Nothing =
        Error.throw "Materialization not supported on fake connection."

    ## PRIVATE
    close : Nothing
    close self = Nothing

    ## PRIVATE
    execute_update : Text | Statement -> Integer
    execute_update self _ =
        Error.throw "Materialization not supported on fake connection."

## PRIVATE
make dialect tables =
    Fake_Test_Connection_Data tables dialect
