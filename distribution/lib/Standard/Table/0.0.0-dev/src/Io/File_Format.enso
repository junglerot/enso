from Standard.Base import all
import Standard.Table

import Standard.Base.Error.Extensions as Errors
from Standard.Base.Error.Problem_Behavior as Problem_Behavior_Module import Problem_Behavior
from Standard.Base.Data.Text.Encoding as Encoding_Module import Encoding
import Standard.Table.Internal.Delimited_Reader

## This type needs to be here to allow for the usage of Standard.Table
   functions. Ideally, it would be an interface within Standard.Base and
   expanded by additional implementations in Standard.Table.

## Determines the format of file to use based on the file extension.
type Auto
    type Auto

    ## ADVANCED
       Gets the underlying File_Format for the specified file
    materialise : File->File_Format
    materialise file =
        extension = file.extension

        output = Ref.new File_Format.Bytes
        if ".txt".equals_ignore_case extension then Ref.put output File_Format.Text
        if ".log".equals_ignore_case extension then Ref.put output File_Format.Text
        if ".csv".equals_ignore_case extension then Ref.put output (File_Format.Delimited ',')
        if ".tsv".equals_ignore_case extension then Ref.put output (File_Format.Delimited '\t')

        Ref.get output

    ## Implements the `File.read` for this `File_Format`
    read : File -> Problem_Behavior -> Any
    read file on_problems =
        materialised = this.materialise file
        materialised.read file on_problems

## Reads the file to a `Vector` of bytes.
type Bytes
    type Bytes

    ## Implements the `File.read` for this `File_Format`
    read : File -> Problem_Behavior -> Any
    read file _ =
        file.read_bytes

## Reads the file to a `Text` with specified encoding.
type Text
    type Text (encoding:Encoding=Encoding.utf_8)

    ## Implements the `File.read` for this `File_Format`
    read : File -> Problem_Behavior -> Any
    read file on_problems =
        file.read_text this.encoding on_problems

## Read delimited files such as CSVs into a Table.
type Delimited
    ## Read delimited files such as CSVs into a Table.

       If a row does not match the first row's column count, the function raises
       an `Invalid_Row`. If a quote is opened and never closed, a
       `Mismatched_Quote` warning occurs.

       Arguments:
       - delimiter: The delimiter character to split the file into columns. An
         `Illegal_Argument_Error` error is returned if this is an empty string.
       - encoding: The encoding to use when reading the file.
       - quote: The quote character denotes the start and end of a quoted value.
         No quote character is used if set to `Nothing`. Quoted items are not
         split on the delimiter and can also contain newlines. Within a quoted
         value, two consecutive quote characters are interpreted as an instance
         of the quote character. Empty input strings must be quoted (e.g. "") as
         otherwise an empty value is treated as `Nothing`.
       - quote_escape: The character to escape the quote character in a quoted
         value. For example, if both `quote` and `quote_escape` are set to `"`,
         then escaping quotes is done by double quotes: `"ab""cd"` will yield
         the text `ab"cd"`. Another popular choice for `quote_escape` is the `\`
         character. Then `"ab\"cd"` will yield the same text.
       - headers: If set to `True`, the first row is used as column names. If
         set to `False`, the column names are generated by adding increasing
         numeric suffixes to the base name `Column` (i.e. `Column_1`,
         `Column_2` etc.). If set to `Infer`, the process tries to infer if
         headers are present on the first row (`Infer` is not implemented yet).
         If the column names are not unique, numeric suffixes will be appended
         to disambiguate them.
       - parse_values: The output columns are parsed using the default `Parser`
         if 'True'. If more control over parsing is needed, the
         `Table.parse_values` method allows full specifications of the parser
         options.
       - skip_rows: The number of rows to skip from the top of the file.
       - row_limit: The maximum number of rows to read from the file. This count
         does not include the header row (if applicable).
       - keep_invalid_rows: Specifies whether rows that contain less or more
         columns than expected should be kept (setting the missing columns to
         `Nothing` or dropping the excess columns) or dropped.

       TODO [RW] The default for `headers` is temporarily changed to `False`,
       because `Infer` is not supported. It should be changed to be the default
       value once the corrresponding task is implemented:
       https://www.pivotaltracker.com/story/show/181986831

       TODO [RW] The default for `parse_values` is temporarily changed to
       `False`, because this feature is not yet implemented. It should be
       changed to `True` once the related task is implemented:
       https://www.pivotaltracker.com/story/show/181824146
    type Delimited (delimiter:Text) (encoding:Encoding=Encoding.utf_8) (quote:Text|Nothing='"') (quote_escape:Text|Nothing='"') (headers:True|False|Infer=False) (parse_values:Boolean=False) (skip_rows:Integer|Nothing=Nothing) (row_limit:Integer|Nothing=Nothing) (keep_invalid_rows:Boolean=True)

    ## Implements the `File.read` for this `File_Format`
    read : File -> Problem_Behavior -> Any
    read file on_problems =
        Delimited_Reader.read_file this file on_problems

## A setting to infer the default behaviour of some option.
type Infer

